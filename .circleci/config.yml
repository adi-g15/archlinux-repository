version: 2

jobs:
  build:
    working_directory: /project
    docker:
      - image: archlinux/base
    steps:
      - checkout
      - restore_cache:
          key: cache-{{ .Environment.CACHE_KEY }}
      - run:
          name: Install development toolchain
          command: pacman -Syu --noconfirm --needed base-devel
      - run:
          name: Setup build environment
          command: make setup
      - run:
          name: Build packages
          command: sudo -ubuild make packages
      - run:
          name: Create repository
          command: make repository
      - save_cache:
          key: ccache-{{ .Environment.CACHE_KEY }}
          paths:
            - /tmp/build
            - /tmp/ccache
      - persist_to_workspace:
          root: /tmp/repository
          paths:
            - .
  deploy:
    docker:
      - image: circleci/buildpack-deps
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/repository
      - run:
          name: Commit
          command: make commit
      - run:
          name: Push to Github
          command: make push

workflows:
  version: 2
  update:
    jobs:
      - build:
          filters:
            branches:
              ignore: gh-pages
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
  nightly:
    triggers:
      - schedule:
          cron: "10 10 * * *"
          filters:
            branches:
              only: master
    jobs:
      - build
      - deploy:
          requires:
            - build
